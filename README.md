# Signaloid C0-microSD Litex Integration
This is an example RISC-V SoC implementation on the Signaloid C0-microSD FPGA that can run C/C++ software.  
This project offers Makefiles to build and flash the FPGA bitstream, and the firmware binary.

## Gateware
This example utilizes the default Signaloid C0-microSD target design from *litex-boards*.
It consists of:
- VexRISC-V-Lite SoC, with IM support.
- UART interface for serial communication support.
- 12MHz default system clock.
- 128kiB SRAM.
- 14MiB binary & files storage on SPI Flash.

## Firmware
The firmware implements a "blink" example, with UART serial communication support.
- Blinking the Signaloid C0-microSD on-board red and green LEDs every 250ms.
- Printing the turned-on LED. 
- Echoing the UART `tx` bytes on `rx`.

## Getting Started
> [!NOTE]  
> This repository assumes that you have already installed the following tools.
> - [Yosys](https://github.com/YosysHQ/yosys)
> - [nextpnr](https://github.com/YosysHQ/nextpnr)
> - [IceStorm](https://github.com/YosysHQ/icestorm)
> - [RISC-V GNU Toolchain](https://github.com/riscv/riscv-gnu-toolchain) for RV32IM ISA extension
> 
> We recommend using the [OSS CAD Suite](https://github.com/YosysHQ/oss-cad-suite-build) to install `Yosys`, `nextpnr`, and `IceStorm`.


Clone this repository recursively.
```sh
git clone --recursive git@github.com:signaloid/C0-microSD-litex-integration
```

Build and flash both gateware and firmware.  
Before running this, make sure that the `CROSS_COMPILE_PATH` variable is properly set in the `config.mk` file with the installation path of the [RISC-V GNU Toolchain](https://github.com/riscv/riscv-gnu-toolchain) for RV32IM ISA extension. Its default value is set to `opt/riscv32im/bin`. Also, make sure that the `DEVICE` variable in the `config.mk` file is set to the correct device path (follow the [Identify the Signaloid C0-microSD](https://c0-microsd-docs.signaloid.io/guides/identify-c0-microsd) guide).
Run this in the project's root directory.
```sh
make flash
```

---

Update all submodules/dependencies.
```sh
git pull --recurse-submodules
git submodule update --remote --recursive
```

Did not clone with `--recursive`? Download all dependencies.
```sh
git submodule update --init --recursive
```
or  
Run the environment preparation make command, on the project's root directory.
```sh
make prep
```

## Structure
This repository is divided into several subdirectories.
- `gateware/`: LiteX SoC design.
- `firmware/`: C based code example.
- `build/`: Litex **generated** directory after the building process. Contains the FPGA design bitstream, the Litex generated C libraries, the compiled firmware binary, and the Litex autogenerated documentation.
- `submodules/`: Dependencies on tools outside this repository.
	- C0-microSD-utilities: C0-microSD-toolkit for flashing purposes.

## Makefiles
This repository contains two Makefiles, one for the gateware, the main `Makefile`, and one for the firmware, the `firmware/Makefile`. The firmware Makefile targets are also accessible from the main Makefile, so you can run its commands from both the `firmware/` and the project's root directory. For details on the firmware Makefile, see the `firmware/README.md` file.

You should should run the following commands from the project's root directory, where the main Makefile is located.

Build both gateware and firmware.
1. Prepares the environment for development, if haven't already.
2. Builds the Litex gateware, and software libraries.
3. Proceeds with synthesize, place 'n' route, and pack.
4. Builds the Litex autogenerated SoC documentation, in the `build/signaloid_c0_microsd/docs/html/` directory.
5. Builds the C firmware.
```sh
make
```
Same as the above.
```sh
make build
```

Flash both gateware and firmware, and build them if changes have been made.
```sh
make flash
```

Clean all build files (deletes everything generated except the virtual environment).
```sh
make clean
```

Clean all virtual environment files.
```sh
make clean-env
```

Prepare the environment for development.  
1. Downloads all git submodules in the *submodules* directory.
2. Creates a python virtual environment at *.venv*.
3. Installs all python required packages defined on the *requirements.txt* file using pip.
```sh
make prep
```

Build the gateware.
```sh
make gateware
```

Flash the gateware. It will also build the gateware if changes have been made.
```sh
make flash-gateware
```

Test the gateware target script for verilog compilation errors. This is useful for debugging the target script.
```sh
make test-target
```

Build the C firmware.
```sh
make firmware
```

Flash the firmware. It will also build the firmware if you have made changes.
```sh
make flash-firmware
```

Clean the firmware build files.
```sh
make clean-firmware
```

Print the firmware variables.
```sh
make print-vars-firmware
```

Print the variables.
```sh
make print-vars
```

## Gateware Bitstream
The gateware bitstream is stored in the `build/signaloid_c0_microsd/gateware/` directory with the name `signaloid_c0_microsd.bin`.

## Firmware Binary
The firmware binary is stored in the `build/signaloid_c0_microsd/software/` directory with the name `signaloid_c0_microsd_firmware.bin`.
